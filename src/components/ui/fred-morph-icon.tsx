"use client";

import { useEffect, useRef, useState, useCallback } from "react";
import { interpolate } from "flubber";

// Letter paths extracted from SVGs (white path data, normalized to 1893x1827 viewBox)
const LETTER_PATHS = {
  F: "M835.641 1232C815.641 1232 798.141 1228.83 783.141 1222.5C768.141 1216.17 754.974 1207.17 743.641 1195.5C732.641 1183.83 722.807 1170.17 714.141 1154.5C706.807 1141.5 700.307 1127.5 694.641 1112.5C689.307 1097.17 684.641 1081.17 680.641 1064.5C676.641 1047.5 673.307 1030.17 670.641 1012.5C667.974 994.5 665.974 976.5 664.641 958.5C663.641 940.5 663.141 922.667 663.141 905C663.141 867 666.807 832.167 674.141 800.5C681.474 768.833 692.307 740.5 706.641 715.5C720.974 690.5 738.807 669 760.141 651C786.474 629 817.641 612.167 853.641 600.5C889.641 588.5 930.307 582.5 975.641 582.5C1004.97 582.5 1035.14 585.667 1066.14 592C1097.47 598.333 1126.47 607.5 1153.14 619.5C1179.81 631.5 1201.31 646 1217.64 663C1234.31 680 1242.64 699.333 1242.64 721C1242.64 740.333 1238.47 755.333 1230.14 766C1222.14 776.667 1210.64 784.5 1195.64 789.5C1181.97 793.833 1165.64 796.667 1146.64 798C1127.64 799 1106.31 799.5 1082.64 799.5C1058.31 799.5 1039.31 802.5 1025.64 808.5C1012.31 814.5 1002.64 822.167 996.641 831.5C995.307 833.5 993.974 836 992.641 839C991.641 842 990.807 845 990.141 848C989.474 851 989.141 853.667 989.141 856C989.141 860.333 989.974 864.333 991.641 868C993.641 871.333 996.307 874.333 999.641 877C1003.31 879.333 1007.47 881.167 1012.14 882.5C1017.14 883.833 1022.47 884.5 1028.14 884.5C1039.81 884.5 1051.14 884.667 1062.14 885C1073.14 885 1083.31 885.333 1092.64 886C1102.31 886.667 1110.64 887.833 1117.64 889.5C1124.97 890.833 1130.81 892.667 1135.14 895C1142.81 899.333 1148.47 906 1152.14 915C1156.14 923.667 1158.14 934 1158.14 946C1158.14 954.667 1156.97 963.333 1154.64 972C1152.31 980.667 1148.47 989 1143.14 997C1134.81 1009.67 1124.81 1019.83 1113.14 1027.5C1101.47 1034.83 1086.47 1040.67 1068.14 1045C1049.81 1049.33 1026.47 1053.33 998.141 1057C979.141 1059.33 966.641 1066 960.641 1077C954.641 1088 951.641 1101.83 951.641 1118.5C951.641 1123.83 951.307 1129.17 950.641 1134.5C950.307 1139.5 949.641 1144.33 948.641 1149C947.974 1153.33 946.974 1157.67 945.641 1162C944.307 1166 942.807 1170 941.141 1174C939.474 1177.67 937.641 1181.17 935.641 1184.5C925.641 1201.5 911.641 1213.67 893.641 1221C875.974 1228.33 856.641 1232 835.641 1232Z",
  R: "M785.172 1237C748.839 1237 717.672 1230 691.672 1216C666.005 1202 646.172 1182.33 632.172 1157C627.172 1147.67 622.839 1136.83 619.172 1124.5C615.505 1112.17 612.505 1098.83 610.172 1084.5C607.839 1069.83 606.005 1055 604.672 1040C603.339 1024.67 602.339 1009.5 601.672 994.5C601.339 979.5 601.172 965.333 601.172 952C601.172 894.667 607.172 845.667 619.172 805C631.172 764.333 648.172 730.667 670.172 704C692.172 677.333 718.339 656.5 748.672 641.5C779.339 626.167 813.172 615.333 850.172 609C887.505 602.667 927.005 599.5 968.672 599.5C1004.67 599.5 1040.01 604 1074.67 613C1109.67 622 1141.34 635.333 1169.67 653C1198.34 670.333 1221.17 691.5 1238.17 716.5C1255.17 741.5 1263.67 770 1263.67 802C1263.67 825 1261.01 844 1255.67 859C1250.34 873.667 1243.01 885.667 1233.67 895C1224.67 904 1214.51 911.167 1203.17 916.5C1191.84 921.5 1180.01 925.833 1167.67 929.5C1160.67 931.5 1154.34 934.333 1148.67 938C1143.34 941.667 1140.67 946.333 1140.67 952C1140.67 956 1145.34 962.333 1154.67 971C1164.34 979.667 1176.01 989.667 1189.67 1001C1203.34 1012.33 1216.84 1024 1230.17 1036C1243.51 1047.67 1254.01 1058.5 1261.67 1068.5C1265.01 1072.83 1268.01 1077.17 1270.67 1081.5C1273.34 1085.83 1275.67 1090.17 1277.67 1094.5C1279.67 1098.83 1281.34 1103.17 1282.67 1107.5C1284.01 1111.5 1285.01 1115.67 1285.67 1120C1286.34 1124.33 1286.67 1128.5 1286.67 1132.5C1286.67 1153.5 1279.84 1171.33 1266.17 1186C1252.51 1200.33 1234.84 1211.17 1213.17 1218.5C1191.84 1225.83 1169.34 1229.5 1145.67 1229.5C1127.01 1229.5 1109.67 1227.33 1093.67 1223C1078.01 1219 1063.67 1213 1050.67 1205C1037.67 1196.67 1025.84 1186.33 1015.17 1174C1004.51 1161.33 994.839 1146.67 986.172 1130C978.172 1114.33 970.005 1100 961.672 1087C953.339 1073.67 945.672 1063 938.672 1055C931.672 1046.67 926.339 1042.5 922.672 1042.5C921.005 1042.5 919.672 1043.17 918.672 1044.5C917.672 1045.83 917.005 1047.83 916.672 1050.5C916.339 1053.17 916.005 1056.33 915.672 1060C915.672 1063.33 915.672 1067.17 915.672 1071.5C915.672 1076.17 915.672 1081.67 915.672 1088C915.672 1094 915.505 1100.33 915.172 1107C915.172 1113.67 914.839 1120.33 914.172 1127C913.839 1133.67 913.339 1140.17 912.672 1146.5C912.005 1152.83 911.005 1158.5 909.672 1163.5C903.005 1192.17 887.672 1211.5 863.672 1221.5C840.005 1231.83 813.839 1237 785.172 1237ZM951.672 857.5C957.005 857.5 962.172 856.833 967.172 855.5C972.505 853.833 977.339 851.5 981.672 848.5C986.339 845.167 990.339 841.333 993.672 837C997.005 832.333 999.505 826.833 1001.17 820.5C1003.17 814.167 1004.17 807.167 1004.17 799.5C1004.17 792.5 1002.67 786.167 999.672 780.5C997.005 774.833 993.172 770.167 988.172 766.5C983.172 762.5 977.505 759.5 971.172 757.5C964.839 755.5 958.172 754.5 951.172 754.5C942.505 754.5 935.505 755.667 930.172 758C924.839 760.333 920.505 763.5 917.172 767.5C913.839 771.167 911.005 775.333 908.672 780C906.672 784 904.839 788.333 903.172 793C901.839 797.667 900.839 802.833 900.172 808.5C899.505 814.167 899.172 821 899.172 829C899.172 835 901.672 840.167 906.672 844.5C911.672 848.833 918.172 852.167 926.172 854.5C934.505 856.5 943.005 857.5 951.672 857.5Z",
  E: "M933.543 1237.5C896.543 1237.5 861.21 1230.67 827.543 1217C793.876 1203.33 765.376 1181.67 742.043 1152C718.71 1122.33 703.376 1083.33 696.043 1035C694.71 1025.67 693.543 1016 692.543 1006C691.543 996 690.71 985.667 690.043 975C689.376 964 688.876 953 688.543 942C688.21 930.667 688.043 919 688.043 907C688.043 844 695.543 791.667 710.543 750C725.543 708.333 747.043 675.5 775.043 651.5C803.376 627.167 837.376 610 877.043 600C917.043 589.667 961.71 584.5 1011.04 584.5C1036.71 584.5 1060.71 586 1083.04 589C1105.38 591.667 1124.88 596.333 1141.54 603C1158.54 609.333 1171.71 618 1181.04 629C1190.71 640 1195.54 653.667 1195.54 670C1195.54 689.667 1190.04 705.667 1179.04 718C1168.38 730.333 1155.21 738.833 1139.54 743.5C1128.54 746.833 1115.04 749.833 1099.04 752.5C1083.38 754.833 1067.54 756.833 1051.54 758.5C1035.88 759.833 1022.21 760.667 1010.54 761C1003.21 761.333 997.21 762.333 992.543 764C988.21 765.333 984.876 767.333 982.543 770C980.21 772.333 978.543 775.167 977.543 778.5C976.876 781.5 976.543 784.5 976.543 787.5C976.543 791.833 977.376 796.167 979.043 800.5C980.71 804.833 983.543 808.333 987.543 811C991.543 813.667 996.876 815 1003.54 815C1011.54 815 1018.88 814.833 1025.54 814.5C1032.21 814.167 1038.54 813.667 1044.54 813C1050.88 812.333 1057.21 811.833 1063.54 811.5C1070.21 811.167 1077.21 811 1084.54 811C1108.88 811 1127.38 817.833 1140.04 831.5C1153.04 845.167 1159.54 864.167 1159.54 888.5C1159.54 925.5 1150.38 951.167 1132.04 965.5C1114.04 979.833 1093.21 987 1069.54 987C1061.21 987 1053.38 987 1046.04 987C1039.04 987 1032.38 987 1026.04 987C1020.04 986.667 1014.21 986.5 1008.54 986.5C1003.21 986.5 998.21 986.5 993.543 986.5C985.21 986.5 978.21 987.667 972.543 990C967.21 992 963.21 994.667 960.543 998C958.21 1001.33 957.043 1005.17 957.043 1009.5C957.043 1012.17 957.71 1014.67 959.043 1017C960.71 1019.33 963.21 1021.33 966.543 1023C969.876 1024.67 974.21 1026.17 979.543 1027.5C984.876 1028.5 991.21 1029.33 998.543 1030C1006.21 1030.67 1015.21 1031 1025.54 1031C1034.54 1031 1044.21 1031.17 1054.54 1031.5C1064.88 1031.5 1075.04 1031.67 1085.04 1032C1095.38 1032.33 1104.38 1032.5 1112.04 1032.5C1139.71 1032.5 1160.38 1039.67 1174.04 1054C1187.71 1068 1194.54 1087.83 1194.54 1113.5C1194.54 1140.5 1186.21 1162.33 1169.54 1179C1152.88 1195.33 1131.21 1207.67 1104.54 1216C1078.21 1224.67 1049.88 1230.33 1019.54 1233C989.21 1236 960.543 1237.5 933.543 1237.5Z",
  D: "M782.988 1234.5C742.988 1234.5 711.155 1229.67 687.488 1220C664.155 1210.67 646.822 1196 635.488 1176C624.155 1156 616.488 1130 612.488 1098C610.488 1082.33 608.988 1065.33 607.988 1047C607.322 1028.67 606.988 1008.83 606.988 987.5C606.988 941.167 608.322 898.167 610.988 858.5C613.655 818.833 619.155 783.333 627.488 752C640.488 704.333 662.322 667.167 692.988 640.5C723.655 613.5 768.655 600 827.988 600C878.655 600 927.155 606.667 973.488 620C1020.15 633.333 1062.99 651.5 1101.99 674.5C1141.32 697.167 1175.49 723 1204.49 752C1233.49 781 1255.99 811.5 1271.99 843.5C1287.99 875.5 1295.99 907.167 1295.99 938.5C1295.99 971.833 1286.82 1003.5 1268.49 1033.5C1250.15 1063.17 1224.65 1090.33 1191.99 1115C1159.32 1139.67 1121.32 1161 1077.99 1179C1034.99 1196.67 988.322 1210.33 937.988 1220C887.988 1229.67 836.322 1234.5 782.988 1234.5ZM910.988 968.5C922.322 968.5 932.655 967.333 941.988 965C951.655 962.333 960.155 959 967.488 955C974.822 951 980.988 946.5 985.988 941.5C991.322 936.5 995.322 931.667 997.988 927C1000.65 922 1001.99 917.5 1001.99 913.5C1001.99 908.833 1000.65 903.833 997.988 898.5C995.655 893.167 991.988 888 986.988 883C981.988 878 975.988 873.5 968.988 869.5C961.988 865.5 954.155 862.333 945.488 860C936.822 857.333 927.322 856 916.988 856C909.655 856 903.655 857.667 898.988 861C894.655 864 891.155 869 888.488 876C887.155 880 886.155 884.667 885.488 890C884.822 895 884.488 900.833 884.488 907.5C884.488 914.5 884.655 921 884.988 927C885.655 933 886.488 938.333 887.488 943C891.155 960 898.988 968.5 910.988 968.5Z",
};

const LETTERS = ["F", "R", "E", "D"] as const;

interface FredMorphIconProps {
  size?: number;
  className?: string;
  speed?: "normal" | "fast";
}

export function FredMorphIcon({ size = 48, className = "", speed = "normal" }: FredMorphIconProps) {
  const [currentPath, setCurrentPath] = useState(LETTER_PATHS.F);
  const letterIndexRef = useRef(0);
  const animationRef = useRef<number | null>(null);
  const timeoutRef = useRef<ReturnType<typeof setTimeout> | null>(null);

  const isFast = speed === "fast";
  const morphDuration = isFast ? 300 : 500;
  const pauseDuration = isFast ? 400 : 1000;
  const initialDelay = isFast ? 0 : 1000;

  const animateToNext = useCallback(() => {
    const fromIndex = letterIndexRef.current;
    const toIndex = (fromIndex + 1) % LETTERS.length;
    const fromPath = LETTER_PATHS[LETTERS[fromIndex]];
    const toPath = LETTER_PATHS[LETTERS[toIndex]];

    const morph = interpolate(fromPath, toPath, { maxSegmentLength: 10 });
    const startTime = performance.now();

    function step(now: number) {
      const elapsed = now - startTime;
      const t = Math.min(elapsed / morphDuration, 1);
      // Ease in-out cubic
      const eased = t < 0.5
        ? 4 * t * t * t
        : 1 - Math.pow(-2 * t + 2, 3) / 2;

      setCurrentPath(morph(eased));

      if (t < 1) {
        animationRef.current = requestAnimationFrame(step);
      } else {
        letterIndexRef.current = toIndex;
        timeoutRef.current = setTimeout(() => {
          animationRef.current = requestAnimationFrame(() => animateToNext());
        }, pauseDuration);
      }
    }

    animationRef.current = requestAnimationFrame(step);
  }, [morphDuration, pauseDuration]);

  useEffect(() => {
    timeoutRef.current = setTimeout(() => {
      animateToNext();
    }, initialDelay);

    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      if (animationRef.current) cancelAnimationFrame(animationRef.current);
    };
  }, [animateToNext, initialDelay]);

  return (
    <div className={isFast ? "animate-pulse" : undefined}>
      <svg
        width={size}
        height={size}
        viewBox="0 0 1893 1827"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
        className={className}
        aria-label="FRED"
        role="img"
      >
        <rect width="1893" height="1827" rx="374" fill="#D5BAFF" />
        <path d={currentPath} fill="white">
          <animate />
        </path>
      </svg>
    </div>
  );
}
